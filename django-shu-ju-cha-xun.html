<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
<link rel="short icon" href="http://softing.qiniudn.com/20140603011448867_easyicon_net_128.ico" type="image/x-ico">
  <meta charset="utf-8">
  <title>Django 数据查询</title>
  <meta name="author" content="tulpar">



  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- <link href="/favicon.png" rel="icon"> -->
  <link href="/theme/css/main.css" media="screen, projection"
        rel="stylesheet" type="text/css">
  <script src="/theme/js/modernizr-2.0.js"></script>
  <script src="/theme/js/ender.js"></script>
  <script src="/theme/js/octopress.js" type="text/javascript"></script>

  <link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
        rel="stylesheet" type="text/css">
</head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="/">Dreaming</a></h1>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>



<ul class="main-navigation">
    <li class="active">
    <a href="/category/it.html">It</a>
    </li>
    <li >
    <a href="/category/life.html">Life</a>
    </li>
</ul></nav>
  <div id="main">
    <div id="content">
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Django 数据查询</h1>
      <p class="meta"><time datetime="2014-09-07T00:00:00" pubdate>日 07 九月 2014</time></p>
</header>

  <div class="entry-content"><div class="highlight"><pre><span class="n">class</span> <span class="n">Poll</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">)</span><span class="o">:</span>
    <span class="n">slug</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">SlugField</span><span class="p">(</span><span class="n">unique_for_month</span><span class="o">=</span><span class="err">&#39;</span><span class="n">pub_date</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">maxlength</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">pub_date</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="n">expire_date</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">()</span>

    <span class="n">def</span> <span class="n">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">question</span>

    <span class="n">class</span> <span class="n">Meta</span><span class="o">:</span>
    <span class="n">get_latest_by</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">pub_date</span><span class="err">&#39;</span>





<span class="n">class</span> <span class="n">Choice</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">)</span><span class="o">:</span>
    <span class="n">poll</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Poll</span><span class="p">,</span> <span class="n">edit_inline</span><span class="o">=</span><span class="n">models</span><span class="p">.</span><span class="n">TABULAR</span><span class="p">,</span>
    <span class="n">num_in_admin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_num_in_admin</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">maxlength</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">core</span><span class="o">=</span><span class="n">True</span><span class="p">)</span>
    <span class="n">votes</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">editable</span><span class="o">=</span><span class="n">False</span><span class="p">,</span> <span class="k">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">__repr__</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">choice</span>
</pre></div>


<h3>获得一个数据对象p1</h3>
<div class="highlight"><pre><span class="n">from</span> <span class="n">datetime</span> <span class="n">import</span> <span class="n">datetime</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">Poll</span><span class="p">(</span><span class="n">slug</span><span class="o">=</span><span class="err">&#39;</span><span class="n">whatsup</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">question</span><span class="o">=</span><span class="s">&quot;What&#39;s up?&quot;</span><span class="p">,</span>\
    <span class="n">pub_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2005</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">expire_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2005</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">p1</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<ul>
<li>数据对象有一个初始方法save()</li>
</ul>
<h3>获取结果集对象</h3>
<h4>无限制获取对象集p2</h4>
<p>```p2=Poll.objects.all()</p>
<blockquote>
<blockquote>
<blockquote>
<p>p2
[What's up?, What's your name?]</p>
</blockquote>
</blockquote>
</blockquote>
<div class="highlight"><pre><span class="cp">###### 注意：在这里p2是个对象集，自身也是个对象。</span>
<span class="cp">#### 增加一些限制条件直到描述的子集满足你的需要。</span>
<span class="err">最常用的两个定制结果集的方法是</span><span class="o">:</span>
</pre></div>


<p>filter(<strong>kwargs)
返回一个匹配查询参数的新的结果集.
exclude(</strong>kwargs)
返回一个不匹配查询参数的新的结果集.</p>
<div class="highlight"><pre><span class="err">这两个方法的返回值都是结果集对象</span><span class="p">,</span><span class="err">因此结果集可以进行链式处理</span><span class="o">:</span>
</pre></div>


<p>Poll.objects.filter(question__startswith="What")\
    .exclude(pub_date__gte=datetime.now())\
    .filter(pub_date__gte=datetime(2005,1,1))</p>
<div class="highlight"><pre><span class="err">以一个初始结果集作为参数</span><span class="p">,</span> <span class="err">然后进行过滤</span><span class="p">,</span> <span class="err">再进行排除</span><span class="p">,</span> <span class="err">再进行另一个过滤</span><span class="p">.</span>   
<span class="err">这样得到的最终结果就一个问题开头单词是</span> <span class="s">&quot;What&quot;</span><span class="p">,</span> <span class="err">发布日期在</span> <span class="mi">2005</span><span class="err">年</span><span class="mi">1</span><span class="err">月</span><span class="mi">1</span><span class="err">日至今的所有民意测验的集合</span><span class="p">.</span>   

<span class="err">每个结果集都是一个独一无二的对象</span><span class="p">.</span> <span class="err">以上操作的每一步都生成了一个新的结果集</span><span class="o">:</span>   
</pre></div>


<p>q1 = Poll.objects.filter(question__startswith="What")
q2 = q1.exclude(pub_date__gte=datetime.now())
q3 = q1.filter(pub_date__gte=datetime.now())</p>
<div class="highlight"><pre><span class="err">这三步生成了三个结果集</span><span class="p">;</span> <span class="err">一个初始结果集包含所有的以</span><span class="s">&quot;What&quot;</span><span class="err">开头的民意测验</span><span class="p">,</span> <span class="err">两个初始结果集的子集</span><span class="p">(</span><span class="err">一个排除条件</span><span class="p">,</span><span class="err">一个过滤条件</span><span class="p">).</span>   
<span class="err">对原始结果集的改进过程并没有影响到原始的结果集</span><span class="p">.</span>
<span class="cp">###### 值得注意的是结果集的创建根本没有访问数据库.只有当对结果集取值时才会访问数据库.</span>

<span class="cp">### 字段查询</span>
<span class="err">以</span> <span class="n">field__lookuptype</span> <span class="p">(</span><span class="err">注意是双下线</span><span class="p">)</span><span class="err">形式进行基本的字段查询</span><span class="p">,</span><span class="err">举例来说</span><span class="o">:</span>
</pre></div>


<p>polls.objects.filter(pub_date__lte=datetime.now())</p>
<div class="highlight"><pre><span class="err">该查询翻译成</span><span class="n">SQL</span><span class="err">就是</span><span class="o">:</span>
</pre></div>


<p>SELECT * FROM polls_polls WHERE pub_date &lt;= NOW();</p>
<div class="highlight"><pre><span class="c">### DB API 支持下列查找类型:</span>
</pre></div>


<p>类型 描述
exact 精确匹配: polls.get_object(id__exact=14).
iexact 忽略大小写的精确匹配: polls.objects.filter(slug__iexact="foo") 匹配 foo, FOO, fOo, 等等.
contains 大小写敏感的内容包含测试: polls.objects.filter(question__contains="spam") 返回question 中包含 "spam" 的所有民意测验.(仅PostgreSQL 和 MySQL支持. SQLite 的LIKE 语句不支持大小写敏感特性. 对Sqlite 来说, contains 等于 icontains.)
icontains 大小写不敏感的内容包含测试:
gt 大于: polls.objects.filter(id__gt=4).
gte 大于等于.
lt 小于.
lte 小于等于.
ne 不等于.
in 位于给定列表中: polls.objects.filter(id__in=[1, 3, 4]) 返回一个 polls 列表(ID 值分别是 1或3或4).
startswith 大小写敏感的 starts-with: polls.objects.filter(question__startswith="Would").(仅PostgreSQL 和MySQL支持. SQLite 的LIKE 语句不支持大小写敏感特性. 对Sqlite 来说,<code>startswith</code> 等于 istartswith)
endswith 大小写敏感的 ends-with. (仅PostgreSQL 和 MySQL)
istartswith 大小写不敏感的 starts-with.
iendswith 大小写不敏感的 ends-with.
range 范围测试: polls.objects.filter(pub_date__range=(start_date, end_date)) 返回 pub_date 位于 start_date 和 end_date (包括)之间的所有民意测验
year 对 date/datetime 字段, 进行精确的 年 匹配: polls.get_count(pub_date__year=2005).
month 对 date/datetime 字段, 进行精确的 月 匹配:
day 对 date/datetime 字段, 进行精确的 日 匹配:
isnull True/False; 做 IF NULL/IF NOT NULL 查询: polls.objects.filter(expire_date__isnull=True).</p>
<div class="highlight"><pre><span class="c">###### 如果未提供查找类型, 系统就认为查找类型是 exact . 下面两个语句是等价的:</span>
</pre></div>


<p>Poll.objects.get(id=14)
Poll.objects.get(id__exact=14)</p>
<div class="highlight"><pre><span class="c">##### 查询允许多个条件参数, 逗号分隔的多个条件参数会被 &quot;AND&quot; 起来使用:</span>
</pre></div>


<p>polls.objects.filter(
    pub_date__year=2005,
    pub_date__month=1,
    question__startswith="Would",
)</p>
<div class="highlight"><pre><span class="err">得到</span><span class="mi">2005</span><span class="err">年</span><span class="mi">1</span><span class="err">月公布的带有一个</span><span class="s">&quot;Would&quot;</span><span class="err">开头的问题的所有民意测验</span><span class="p">.</span>
<span class="cp">##### 为了使用更加方便, 还提供有一个 pk 查找类型, 可以翻译成 (primary_key)__exact. </span>
<span class="err">在这个民意测试的例子里</span><span class="p">,</span> <span class="err">下面两个语句是等价的</span><span class="p">.</span><span class="o">:</span>
</pre></div>


<p>polls.get_object(id__exact=3)
polls.get_object(pk=3)</p>
<div class="highlight"><pre><span class="cp">##### pk 也可以通过连接进行查询. </span>
<span class="err">在这个民意测试的例子里</span><span class="p">,</span> <span class="err">下面两个语句是等价的</span><span class="o">:</span>
</pre></div>


<p>choices.objects.filter(poll__id__exact=3)
choices.objects.filter(poll__pk=3)</p>
<div class="highlight"><pre><span class="err">如果传递的关键字参数非法</span><span class="p">,</span> <span class="err">将引发</span> <span class="n">TypeError</span> <span class="err">异常</span><span class="p">.</span>
<span class="cp">#### OR 查询</span>
<span class="err">关键字参数查询的各个条件都是</span> <span class="s">&quot;AND&quot;</span> <span class="err">关系</span><span class="p">.</span> <span class="err">如果你需要一个复杂的查询</span><span class="p">(</span><span class="err">举例来说</span><span class="p">,</span><span class="err">你需要一个</span> <span class="n">OR</span> <span class="err">语句</span><span class="p">),</span> <span class="err">你需要使用</span> <span class="n">Q</span> <span class="err">对象</span><span class="p">.</span>      
<span class="n">Q</span> <span class="err">对象是</span> <span class="n">django</span><span class="p">.</span><span class="n">core</span><span class="p">.</span><span class="n">meta</span><span class="p">.</span><span class="n">Q</span> <span class="err">的实例</span><span class="p">,</span> <span class="err">用来装载一系列关键字参数</span><span class="p">.</span> <span class="err">这些关键字参数就象指定给</span> <span class="n">get</span><span class="p">()</span> <span class="err">和</span> <span class="n">filter</span><span class="p">()</span> <span class="err">函数的关键字参数一样</span><span class="p">.</span> <span class="err">举例来说</span><span class="o">:</span>
</pre></div>


<p>Q(question__startswith='What')</p>
<div class="highlight"><pre><span class="n">Q</span> <span class="err">对象可以使用</span> <span class="o">&amp;</span> <span class="err">和</span> <span class="o">|</span> <span class="err">运算符进行组合</span><span class="p">.</span> <span class="err">当两个</span><span class="n">Q</span><span class="err">对象进行</span> <span class="o">&amp;</span> <span class="err">或</span> <span class="o">|</span> <span class="err">运算时</span><span class="p">,</span><span class="err">会生成一个新的</span><span class="n">Q</span><span class="err">对象</span><span class="p">.</span><span class="err">举例来说语句</span><span class="o">:</span>
</pre></div>


<p>Q(question__startswith='Who') | Q(question__startswith='What')</p>
<div class="highlight"><pre><span class="err">生成一个新的</span> <span class="n">Q</span> <span class="err">对象表示这两个</span> <span class="s">&quot;question__startswith&quot;</span> <span class="err">查询条件的</span> <span class="s">&quot;OR&quot;</span> <span class="err">关系</span><span class="p">.</span> <span class="err">等同于下面的</span> <span class="n">SQL</span> <span class="n">WHERE</span> <span class="err">子句</span><span class="o">:</span>
</pre></div>


<p>WHERE question LIKE 'Who%' OR question LIKE 'What%'</p>
<div class="highlight"><pre><span class="err">查询函数可以接受一个或多个</span> <span class="n">Q</span> <span class="err">对象作为参数</span><span class="p">.</span><span class="err">如果提供有多个</span> <span class="n">Q</span> <span class="err">对象参数</span><span class="p">,</span> <span class="err">它们将被</span> <span class="s">&quot;AND&quot;</span> <span class="err">到一起</span><span class="p">.</span> <span class="err">举例来说</span><span class="o">:</span>
</pre></div>


<p>polls.get_object(
Q(question__startswith='Who'),
Q(pub_date__exact=date(2005, 5, 2)) | Q(pub_date__exact=date(2005, 5, 6))
)</p>
<div class="highlight"><pre><span class="err">翻译成</span> <span class="n">SQL</span> <span class="err">就是这样</span><span class="o">:</span>
</pre></div>


<p>SELECT * from polls WHERE question LIKE 'Who%'
AND (pub_date = '2005-05-02' OR pub_date = '2005-05-06')</p>
<div class="highlight"><pre><span class="cp">### 从结果集中取值</span>
<span class="err">只有通过取值操作才能得到结果集包含的对象</span><span class="p">.</span><span class="err">取值操作可以通过迭代</span><span class="p">,</span><span class="err">切片</span><span class="p">,</span><span class="err">或其它专门的函数来实现</span><span class="p">.</span>   
<span class="cp">##### 一个结果集就是一个可迭代对象.</span>
<span class="err">因此</span><span class="p">,</span><span class="err">可以通过一个循环来取出它的值</span><span class="o">:</span>
</pre></div>


<p>for p in Poll.objects.all():
print p</p>
<div class="highlight"><pre><span class="err">将使用</span> <span class="n">Poll</span> <span class="err">对象的</span> <span class="n">__repr__</span><span class="p">()</span> <span class="err">方法打印出所有的</span> <span class="n">Poll</span> <span class="err">对象</span><span class="p">.</span>
<span class="cp">##### 一个结果集也可以被切片, 使用数组符号操作:</span>
</pre></div>


<p>fifth_poll = Poll.objects.all()[4]
all_polls_but_the_first_two = Poll.objects.all()[2:]
every_second_poll = Poll.objects.all()[::2]</p>
<div class="highlight"><pre><span class="cp">###### 结果集对象是惰性对象 - 也就是说,他们不是 真正的 包含他们表示对象的集合 (或列表).</span>
<span class="cp">###### Python 的协议魔法让结果集看起来是一个可迭代,可切片的对象. 事实上在幕后, Django 使用了缓存技术..</span>
<span class="err">如果你真的需要一个列表</span><span class="p">,</span> <span class="err">你可以强制对一个惰性对象取值</span><span class="o">:</span>
</pre></div>


<p>querylist = list(Poll.objects.all())</p>
<div class="highlight"><pre><span class="err">不过</span><span class="p">,</span><span class="err">最好不要这么做</span><span class="p">,</span><span class="err">尤其当一个结果集相当大时</span><span class="p">.</span> <span class="err">由于</span> <span class="n">Django</span> <span class="err">要创建每一个对象的内存表示</span><span class="p">,</span><span class="err">这将占用相当大的内存</span><span class="p">.</span>
<span class="cp">### 结果集及其缓存行为</span>
<span class="err">每个结果集都包含一个</span> <span class="n">cache</span><span class="p">.</span> <span class="err">对一个新创建的结果集来说</span><span class="p">,</span> <span class="err">缓存区是空的</span><span class="p">.</span><span class="err">当一个结果集第一次被取值</span><span class="p">,</span> <span class="n">Django</span> <span class="err">会进行一次数据库查询</span><span class="p">,</span><span class="err">并将查询结果放入缓存中</span><span class="p">,</span> <span class="err">之后返回用户需要的数据</span><span class="p">.</span> <span class="err">后面的取值操作会使用缓存中的数据而不用再次访问数据库</span><span class="p">.</span>

<span class="err">必须时刻记住</span><span class="o">:</span><span class="err">结果集具有缓存行为</span><span class="p">.</span> <span class="err">下面两行语句生成了两个临时的结果集</span><span class="p">,</span><span class="err">并进行了取值</span><span class="p">,</span><span class="err">之后舍弃</span><span class="o">:</span>
</pre></div>


<p>print [p for p in Poll.objects.all()] # Evaluate the Query Set
print [p for p in Poll.objects.all()] # Evaluate the Query Set again</p>
<div class="highlight"><pre><span class="err">对一个小型的</span><span class="p">,</span><span class="err">低流量的站点来说</span><span class="p">,</span><span class="err">这不会造成严重问题</span><span class="p">.</span>   
<span class="err">不过</span><span class="p">,</span><span class="err">对一个高访问量的站点来说</span><span class="p">,</span><span class="err">它双倍增加了数据库服务器的负担</span><span class="p">.</span>   
<span class="err">另外</span><span class="p">,</span><span class="err">由于在两次操作之间可能有其它的用户增加或删除了投票</span><span class="p">,</span><span class="err">因此这两次操作得到结果可能并不相同</span><span class="p">.</span>

<span class="cp">##### 要避免这个问题, 保存这个结果集并在后面重用该结果集:</span>
</pre></div>


<p>queryset = Poll.objects.all()
print [p for p in queryset] # Evaluate the query set
print [p for p in queryset] # Re-use the cache from the evaluation</p>
<div class="highlight"><pre><span class="err">###</span> <span class="err">关系</span> <span class="p">(</span><span class="err">连接</span><span class="p">)</span>
<span class="err">当你在</span> <span class="nx">model</span> <span class="err">中定义了一个关系字段</span><span class="p">(</span><span class="err">也就是</span><span class="p">,</span><span class="err">一个</span><span class="nx">ForeignKey</span><span class="p">,</span> <span class="nx">OneToOneField</span><span class="p">,</span> <span class="err">或</span> <span class="nx">ManyToManyField</span><span class="p">).</span>  
<span class="nx">Django</span> <span class="err">使用关系字段的名字为</span> <span class="nx">model</span> <span class="err">的每个实例添加一个</span> <span class="err">描述符</span><span class="p">.</span>   
<span class="err">在访问对象或关联对象时</span><span class="p">,</span> <span class="err">这个描述符就象一个常规属性</span><span class="p">.</span>   
<span class="err">举例来说</span><span class="p">,</span> <span class="nx">mychoice</span><span class="p">.</span><span class="nx">poll</span> <span class="err">会返回</span> <span class="nx">Choice</span> <span class="err">实例对象关联的</span> <span class="nx">Poll</span> <span class="err">对象</span><span class="p">.</span>


<span class="err">通过下面的关系</span><span class="p">,</span><span class="err">连接可以以非显式的方式进行</span><span class="o">:</span>   
<span class="err">`</span><span class="nx">choices</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">poll__slug</span><span class="o">=</span><span class="s2">&quot;eggs&quot;</span><span class="p">)</span><span class="err">`</span>    
<span class="err">得到一个</span> <span class="nx">Choice</span> <span class="err">对象列表</span><span class="p">,</span> <span class="err">这些对象关联的</span> <span class="nx">Poll</span> <span class="err">对象的</span> <span class="nx">slug</span> <span class="err">字段值为</span> <span class="nx">eggs</span><span class="p">.</span> <span class="err">允许多级连接</span><span class="p">.</span>   


<span class="err">通过一个对象实例的便利函数</span><span class="p">(</span><span class="nx">convenience</span> <span class="nx">functions</span><span class="p">)</span><span class="err">就可直接查询该对象的关联对象</span><span class="p">.</span> <span class="err">举例来说</span><span class="p">,</span> <span class="err">如果</span> <span class="nx">p</span> <span class="err">是一个</span> <span class="nx">Poll</span> <span class="err">实例</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">choice_set</span><span class="p">()</span> <span class="err">将返回所有关联的</span> <span class="nx">Choice</span> <span class="err">对象列表</span><span class="p">.</span> <span class="err">聪明的读者会注意到它等价于</span> <span class="nx">choices</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">poll__id</span><span class="o">=</span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span> <span class="err">只是更加清晰</span><span class="p">.</span>

<span class="err">####</span> <span class="nx">One</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">one</span> <span class="nx">relations</span>
<span class="err">#####</span> <span class="nx">one</span><span class="o">-</span><span class="nx">to</span><span class="o">-</span><span class="nx">one</span> <span class="err">关系中的每个对象拥有一个</span> <span class="nx">get_relatedobjectname</span><span class="p">()</span> <span class="err">方法</span><span class="p">.</span>
 <span class="err">举例来说</span><span class="o">:</span>
</pre></div>


<p>class Place(meta.Model):</p>
<h1>...</h1>
<p>class Restaurant(meta.Model):</p>
<h1>...</h1>
<div class="highlight"><pre><span class="n">the_place</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">places</span><span class="p">.</span><span class="n">Place</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span class="err">在上面的例子里</span><span class="p">,</span> <span class="err">每个</span> <span class="n">Place</span> <span class="err">会自动拥有一个</span> <span class="n">get_restaurant</span><span class="p">()</span> <span class="err">方法</span><span class="p">,</span>   
<span class="err">且每个</span> <span class="n">Restaurant</span> <span class="err">会自动拥有一个</span> <span class="n">get_the_place</span><span class="p">()</span> <span class="err">方法</span><span class="p">.</span>

<span class="cp">#### Many-to-one relations</span>
<span class="err">在</span> <span class="n">many</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">one</span> <span class="err">关系中</span><span class="p">,</span> <span class="err">关联对象</span><span class="p">(</span><span class="n">Many</span><span class="p">)</span><span class="err">会自动拥有一个</span> <span class="n">get_relatedobject</span><span class="p">()</span> <span class="err">方法</span><span class="p">.</span>    
<span class="err">被关联的对象</span><span class="p">(</span><span class="n">one</span><span class="p">)</span><span class="err">会自动拥有</span> <span class="n">get_relatedobject</span><span class="p">(),</span> <span class="n">get_relatedobject_list</span><span class="p">(),</span> <span class="err">和</span> <span class="n">get_relatedobject_count</span><span class="p">()</span> <span class="err">方法</span> <span class="p">(</span><span class="err">功能与模块级的</span> <span class="n">get_object</span><span class="p">(),</span> <span class="n">filter</span><span class="p">(),</span> <span class="err">和</span> <span class="n">get_count</span><span class="p">()</span> <span class="err">相同</span><span class="p">).</span>

<span class="err">在上面的民意测试例子里</span><span class="p">,</span> <span class="err">一个</span> <span class="n">Poll</span> <span class="err">对象</span> <span class="n">p</span> <span class="err">自动拥有下列方法</span><span class="o">:</span>
</pre></div>


<p>p.get_choice()
p.get_choice_list()
p.get_choice_count()</p>
<div class="highlight"><pre><span class="n">Choice</span> <span class="err">对象</span> <span class="n">c</span> <span class="err">则自动拥有下面的方法</span><span class="o">:</span>
<span class="err">`</span><span class="n">c</span><span class="p">.</span><span class="n">get_poll</span><span class="p">()</span><span class="err">`</span>   
<span class="cp">#### Many-to-many 关系</span>
<span class="n">Many</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">many</span> <span class="err">关系类似`</span><span class="n">Many</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">one</span> <span class="n">relations</span><span class="err">`</span><span class="n">_</span><span class="p">,</span> <span class="err">它生成同样的方法集</span><span class="p">.</span><span class="err">例外的是关联对象的</span> <span class="n">get_relatedobject_list</span><span class="p">()</span> <span class="err">方法返回一个实例的列表而不是一个仅一个实例</span><span class="p">.</span><span class="err">因此</span><span class="p">,</span><span class="err">若</span> <span class="n">Poll</span> <span class="err">和</span> <span class="n">Choice</span> <span class="err">是</span> <span class="n">many</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">many</span> <span class="err">关系</span><span class="p">,</span> <span class="n">choice</span><span class="p">.</span><span class="n">get_poll_list</span><span class="p">()</span> <span class="err">将返回一个列表</span><span class="p">.</span>   
<span class="cp">##### 专门的结果集</span>
<span class="err">除</span> <span class="n">filter</span> <span class="err">和</span> <span class="n">exclude</span><span class="p">()</span> <span class="err">之外</span><span class="p">,</span> <span class="n">Django</span> <span class="err">提供了一系列结果集处理方法</span><span class="p">,</span> <span class="err">修改结果的类型</span><span class="p">,</span> <span class="err">或修改</span> <span class="n">sql</span> <span class="err">查询在数据库执行的方式</span><span class="p">.</span>
</pre></div>


<p>order_by(*fields)</p>
<div class="highlight"><pre><span class="err">根据</span> <span class="n">model</span> <span class="err">中提供</span> <span class="n">ordering</span> <span class="n">tuple</span><span class="p">,</span> <span class="err">结果集会被自动排序</span><span class="p">.</span> <span class="err">不过</span><span class="p">,</span> <span class="err">排序也可以通过</span> <span class="n">order_by</span> <span class="err">方法显式的进行</span><span class="o">:</span>
</pre></div>


<p>Poll.objects.filter(pub_date__year=2005,
pub_date__month=1).order_by('-pub_date', 'question')</p>
<div class="highlight"><pre><span class="err">结果集将按降序排列</span> <span class="n">pub_date</span><span class="p">,</span> <span class="err">然后按升序排列</span> <span class="n">question</span><span class="p">.</span><span class="s">&quot;-pub_date&quot;</span> <span class="err">中的负号表示降序</span><span class="p">(</span><span class="err">递减</span><span class="p">).</span><span class="err">要取随机序</span><span class="p">,</span><span class="err">使用</span><span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="err">象下面这样</span><span class="o">:</span>
</pre></div>


<p>Poll.objects.order_by=('?')</p>
<div class="highlight"><pre><span class="err">要按另一个表中的字段排序</span><span class="p">,</span> <span class="err">添加另一个表的名字和一个句点</span><span class="p">,</span><span class="err">象下面这样</span><span class="o">:</span>
</pre></div>


<p>Choice.objects.order_by=('Poll.pub_date', 'choice')</p>
<div class="highlight"><pre><span class="cp">### values(*fields)</span>
<span class="err">类似</span> <span class="n">filter</span><span class="p">(),</span> <span class="err">不过它返回一个字典的列表而不是</span> <span class="n">model</span> <span class="err">实例对象的列表</span><span class="p">.</span>   

<span class="err">它接受一个可选参数</span><span class="o">:</span> <span class="n">fields</span><span class="p">,</span> <span class="err">这是一个字段名列表或</span><span class="n">tuple</span><span class="p">.</span><span class="err">如果你没有指定</span> <span class="n">fields</span><span class="p">,</span> <span class="err">每个字段都会返回</span><span class="p">.</span>   
<span class="err">否则就只返回你指定的字段名和值</span><span class="p">.</span><span class="err">这里有一个例子</span><span class="p">,</span><span class="err">使用上面定义的</span> <span class="n">Poll</span> <span class="n">model</span>
</pre></div>


<blockquote>
<blockquote>
<blockquote>
<p>from datetime import datetime
p1 = Poll(slug='whatsup', question="What's up?",
... pub_date=datetime(2005, 2, 20), expire_date=datetime(2005, 3, 20))
p1.save()
p2 = Poll(slug='name', question="What's your name?",
... pub_date=datetime(2005, 3, 20), expire_date=datetime(2005, 4, 20))
p2.save()
Poll.objects.all()
[What's up?, What's your name?]
Poll.objects.values()
[{'id': 1, 'slug': 'whatsup', 'question': "What's up?", 'pub_date': datetime.datetime(2005, 2, 20), 'expire_date': datetime.datetime(2005, 3, 20)},
{'id': 2, 'slug': 'name', 'question': "What's your name?", 'pub_date': datetime.datetime(2005, 3, 20), 'expire_date': datetime.datetime(2005, 4, 20)}]
Poll.objects.values(fields=['id', 'slug'])
[{'id': 1, 'slug': 'whatsup'}, {'id': 2, 'slug': 'name'}]
```</p>
</blockquote>
</blockquote>
</blockquote>
<h4>当你知道你要取得哪些字段的值时并且你不需要那些 model实例对象的功能时,使用 values() 函数.</h4></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">tulpar</span>
  </span>
<time datetime="2014-09-07T00:00:00" pubdate>日 07 九月 2014</time>  <span class="categories">
    <a class="category" href="/tag/django.html">Django</a>
  </span>
</p><div class="sharing">
</div>    </footer>
  </article>



<!-- Duoshuo Comment BEGIN -->
<div class="ds-thread"></div>
<script type="text/javascript">
var duoshuoQuery = {short_name:"tlbog"};
(function() {
var ds = document.createElement('script');
ds.type = 'text/javascript';ds.async = true;
ds.src = 'http://static.duoshuo.com/embed.js';
ds.charset = 'UTF-8';
(document.getElementsByTagName('head')[0] 
|| document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script>
<!-- Duoshuo Comment END -->

</div>
<aside class="sidebar">
  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
          <a href="/django-17shi-yong.html">Django 1.7试用</a>
      </li>
      <li class="post">
          <a href="/django-shu-ju-cha-xun.html">Django 数据查询</a>
      </li>
      <li class="post">
          <a href="/ubuntu-1204zhong-wen-shu-ru-fa-de-an-zhuang.html">Ubuntu 12.04中文输入法的安装</a>
      </li>
      <li class="post">
          <a href="/hui-jia-lu.html">回家路</a>
      </li>
      <li class="post">
          <a href="/ge-shi-hua-zi-fu-chuan-shi-jian.html">格式化字符串——时间</a>
      </li>
    </ul>
  </section>
  <section>
      
    <h1>Categories</h1>
    <ul id="recent_posts">
        <li><a href="/category/it.html">It</a></li>
        <li><a href="/category/life.html">Life</a></li>
    </ul>
  </section>
 

  <section>
  <h1>Tags</h1>
    <a href="/tag/shell.html">Shell</a>,    <a href="/tag/userena.html">userena</a>,    <a href="/tag/git.html">Git</a>,    <a href="/tag/socketio.html">Socket.io</a>,    <a href="/tag/python.html">Python</a>,    <a href="/tag/linux.html">Linux</a>,    <a href="/tag/tmux.html">Tmux</a>,    <a href="/tag/django.html">Django</a>,    <a href="/tag/xadmin.html">Xadmin</a>,    <a href="/tag/du-shu.html">读书</a>,    <a href="/tag/github.html">Github</a>,    <a href="/tag/ueditor.html">Ueditor</a>,    <a href="/tag/ngrok.html">ngrok</a>,    <a href="/tag/ssh.html">ssh</a>,    <a href="/tag/mysql.html">Mysql</a>,    <a href="/tag/bo-ke.html">博客</a>,    <a href="/tag/edx.html">Edx</a>,    <a href="/tag/fan-qiang.html">翻墙</a>,    <a href="/tag/ubuntu.html">Ubuntu</a>,    <a href="/tag/virtualbox.html">VirtualBox</a>,    <a href="/tag/wo-ai-wo-jia.html">我爱我家</a>  </section>


    <section>
        <h1>Social</h1>
        <ul>
            <li><a href="http://izda.com" target="_blank">ئىزدە</a></li>
            <li><a href="http://www.google.com" target="_blank">Google</a></li>
            <li><a href="http://www.zhihu.com/" target="_blank">知乎</a></li>
            <li><a href="http://www.douban.com/" target="_blank">豆瓣</a></li>
        </ul>
    </section>
    <section>
        <h1>Blogroll</h1>
        <ul>
            <li><a href="https://github.com/tulpar008" target="_blank">My Github</a></li>
            <li><a href="#" target="_blank">tulpar008@gmail.com</a></li>
        </ul>
    </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2013-2014  - tulpar -
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
</body>
</html>